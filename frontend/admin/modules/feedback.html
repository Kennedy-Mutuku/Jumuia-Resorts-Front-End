<!-- admin/modules/feedback.html -->
<div id="feedbackModule" class="module-content">
    <div class="content-header">
        <div class="breadcrumb">
            <a href="dashboard.html">Dashboard</a> / 
            <span>Feedback & Reviews</span>
        </div>
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="exportFeedback()">
                <i class="fas fa-download"></i>
                Export Data
            </button>
            <button class="btn btn-secondary" onclick="refreshFeedback()">
                <i class="fas fa-sync-alt"></i>
                Refresh
            </button>
        </div>
    </div>

    <!-- Stats Overview -->
    <div class="stats-overview">
        <div class="stat-card">
            <div class="stat-number" id="totalFeedback">0</div>
            <div class="stat-label">Total Feedback</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="averageRating">0.0</div>
            <div class="stat-label">Avg Rating</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="pendingReviews">0</div>
            <div class="stat-label">Pending Review</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="recommendRate">0%</div>
            <div class="stat-label">Recommendation Rate</div>
        </div>
    </div>

    <!-- Filter Controls -->
    <div class="filter-controls">
        <div class="form-row">
            <div class="form-group">
                <label>Filter by Property</label>
                <select id="propertyFilter" class="form-control" onchange="loadFeedback()">
                    <option value="all">All Properties</option>
                    <option value="limuru">Limuru</option>
                    <option value="kanamai">Kanamai</option>
                    <option value="kisumu">Kisumu</option>
                </select>
            </div>
            <div class="form-group">
                <label>Filter by Rating</label>
                <select id="ratingFilter" class="form-control" onchange="loadFeedback()">
                    <option value="all">All Ratings</option>
                    <option value="5">5 Stars</option>
                    <option value="4">4 Stars & Above</option>
                    <option value="3">3 Stars & Above</option>
                    <option value="2">2 Stars & Above</option>
                    <option value="1">1 Star</option>
                </select>
            </div>
            <div class="form-group">
                <label>Filter by Status</label>
                <select id="statusFilter" class="form-control" onchange="loadFeedback()">
                    <option value="all">All Status</option>
                    <option value="pending">Pending Review</option>
                    <option value="published">Published</option>
                    <option value="archived">Archived</option>
                    <option value="replied">Replied</option>
                </select>
            </div>
            <div class="form-group">
                <label>Date Range</label>
                <select id="dateFilter" class="form-control" onchange="loadFeedback()">
                    <option value="all">All Time</option>
                    <option value="today">Today</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                    <option value="quarter">Last 3 Months</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Feedback Table -->
    <div class="feedback-table-container">
        <div class="table-header">
            <h3>Guest Feedback</h3>
            <div class="table-actions">
                <button class="btn btn-secondary" onclick="bulkAction('publish')">
                    <i class="fas fa-check"></i> Publish Selected
                </button>
                <button class="btn btn-secondary" onclick="bulkAction('archive')">
                    <i class="fas fa-archive"></i> Archive Selected
                </button>
            </div>
        </div>
        
        <div class="table-scroll">
            <table class="feedback-table">
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                        </th>
                        <th>Guest</th>
                        <th>Property</th>
                        <th>Rating</th>
                        <th>Feedback</th>
                        <th>Status</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="feedbackTableBody">
                    <tr>
                        <td colspan="8" class="loading-state">
                            <i class="fas fa-spinner fa-spin"></i> Loading feedback...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="table-footer">
            <div class="pagination-info">
                Showing <span id="currentCount">0</span> of <span id="totalCount">0</span> feedback entries
            </div>
            <div class="pagination-controls">
                <button class="btn btn-secondary" onclick="prevPage()" id="prevBtn" disabled>
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                <button class="btn btn-secondary" onclick="nextPage()" id="nextBtn" disabled>
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Property Performance Charts -->
    <div class="charts-section">
        <div class="chart-card">
            <h3>Rating Distribution</h3>
            <canvas id="ratingDistributionChart" height="250"></canvas>
        </div>
        <div class="chart-card">
            <h3>Feedback by Property</h3>
            <canvas id="propertyFeedbackChart" height="250"></canvas>
        </div>
    </div>
</div>

<style>
    /* Feedback Module CSS - Jumuia Resorts Branding */
    
    /* Stats Overview */
    .stats-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background-color: var(--primary-white);
        padding: 25px;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        border-left: 4px solid var(--primary-orange);
        transition: transform 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
    }
    
    .stat-card:nth-child(2) {
        border-left-color: var(--secondary-green);
    }
    
    .stat-card:nth-child(3) {
        border-left-color: #ffc107;
    }
    
    .stat-card:nth-child(4) {
        border-left-color: #17a2b8;
    }
    
    .stat-number {
        font-size: 2.8rem;
        font-weight: 700;
        color: var(--primary-green);
        margin-bottom: 8px;
        font-family: 'Montserrat', sans-serif;
        line-height: 1;
    }
    
    .stat-label {
        color: var(--text-light);
        font-size: 1.1rem;
        font-weight: 500;
    }
    
    /* Filter Controls */
    .filter-controls {
        background-color: var(--primary-white);
        padding: 25px;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        margin-bottom: 30px;
    }
    
    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
    }
    
    .form-group {
        display: flex;
        flex-direction: column;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 10px;
        font-weight: 600;
        color: var(--primary-green);
        font-size: 0.95rem;
    }
    
    .form-control {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid var(--gray-border);
        border-radius: var(--radius);
        font-family: 'Montserrat', sans-serif;
        font-size: 1rem;
        color: var(--text-dark);
        background-color: var(--primary-white);
        transition: all 0.3s ease;
    }
    
    .form-control:focus {
        outline: none;
        border-color: var(--primary-orange);
        box-shadow: 0 0 0 3px rgba(243, 164, 53, 0.1);
    }
    
    /* Feedback Table */
    .feedback-table-container {
        background-color: var(--primary-white);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        overflow: hidden;
        margin-bottom: 30px;
    }
    
    .table-header {
        padding: 20px 25px;
        border-bottom: 1px solid var(--gray-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: var(--light-green);
    }
    
    .table-header h3 {
        color: var(--primary-green);
        font-family: 'Playfair Display', serif;
        font-size: 1.5rem;
        margin: 0;
        font-weight: 600;
    }
    
    .table-actions {
        display: flex;
        gap: 12px;
    }
    
    .table-scroll {
        overflow-x: auto;
    }
    
    .feedback-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 1000px;
    }
    
    .feedback-table thead {
        background-color: var(--light-green);
    }
    
    .feedback-table th {
        padding: 18px 20px;
        text-align: left;
        font-weight: 600;
        color: var(--primary-green);
        font-size: 0.95rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 2px solid var(--primary-green);
    }
    
    .feedback-table th input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: var(--primary-green);
    }
    
    .feedback-table tbody tr {
        border-bottom: 1px solid var(--gray-border);
        transition: background-color 0.2s ease;
    }
    
    .feedback-table tbody tr:hover {
        background-color: rgba(233, 245, 229, 0.3);
    }
    
    .feedback-table td {
        padding: 18px 20px;
        vertical-align: middle;
    }
    
    .guest-info {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .guest-avatar {
        width: 40px;
        height: 40px;
        background-color: var(--light-green);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: var(--primary-green);
        font-size: 1rem;
        flex-shrink: 0;
    }
    
    .guest-details {
        min-width: 0;
    }
    
    .guest-name {
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 3px;
    }
    
    .guest-email {
        font-size: 0.85rem;
        color: var(--text-light);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .property-badge {
        background-color: var(--light-green);
        color: var(--primary-green);
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        display: inline-block;
        text-align: center;
        min-width: 80px;
    }
    
    .rating-stars {
        color: var(--primary-orange);
        font-size: 1.2rem;
        letter-spacing: 2px;
        margin-bottom: 5px;
    }
    
    .rating-value {
        font-size: 0.85rem;
        color: var(--text-light);
    }
    
    .feedback-title {
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 5px;
        font-size: 0.95rem;
    }
    
    .feedback-preview {
        color: var(--text-light);
        font-size: 0.9rem;
        max-width: 300px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .status-badge {
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        display: inline-block;
        text-align: center;
        min-width: 100px;
    }
    
    .status-pending {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .status-published {
        background-color: #d4edda;
        color: #155724;
    }
    
    .status-archived {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .status-replied {
        background-color: #cce5ff;
        color: #004085;
    }
    
    .feedback-date {
        color: var(--text-light);
        font-size: 0.9rem;
        white-space: nowrap;
    }
    
    .action-buttons {
        display: flex;
        gap: 10px;
    }
    
    .action-btn {
        background: none;
        border: none;
        color: var(--primary-green);
        cursor: pointer;
        font-size: 1.1rem;
        transition: all 0.3s ease;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .action-btn:hover {
        background-color: var(--light-green);
        transform: scale(1.1);
    }
    
    .action-btn.view {
        color: var(--primary-green);
    }
    
    .action-btn.edit {
        color: var(--primary-orange);
    }
    
    .action-btn.reply {
        color: var(--secondary-green);
    }
    
    .loading-state {
        padding: 60px 20px;
        text-align: center;
        color: var(--text-light);
        font-size: 1.1rem;
    }
    
    .loading-state i {
        margin-right: 10px;
    }
    
    .table-footer {
        padding: 20px 25px;
        border-top: 1px solid var(--gray-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .pagination-info {
        color: var(--text-light);
        font-size: 0.95rem;
    }
    
    .pagination-controls {
        display: flex;
        gap: 12px;
    }
    
    /* Charts Section */
    .charts-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 30px;
        margin-top: 30px;
    }
    
    .chart-card {
        background-color: var(--primary-white);
        padding: 30px;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
    }
    
    .chart-card h3 {
        margin-bottom: 25px;
        color: var(--primary-green);
        font-family: 'Playfair Display', serif;
        font-size: 1.4rem;
        font-weight: 600;
    }
    
    /* Buttons */
    .btn {
        padding: 12px 28px;
        border-radius: var(--radius);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
        font-family: 'Montserrat', sans-serif;
        font-size: 1rem;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        text-decoration: none;
        outline: none;
    }
    
    .btn-primary {
        background-color: var(--primary-orange);
        color: var(--primary-white);
    }
    
    .btn-primary:hover {
        background-color: #e5941f;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(243, 164, 53, 0.2);
    }
    
    .btn-secondary {
        background-color: transparent;
        color: var(--primary-green);
        border: 2px solid var(--primary-green);
    }
    
    .btn-secondary:hover {
        background-color: var(--primary-green);
        color: var(--primary-white);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(34, 68, 15, 0.1);
    }
    
    .btn-secondary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    .btn-secondary:disabled:hover {
        background-color: transparent;
        color: var(--primary-green);
    }
    
    /* Content Header */
    .content-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 35px;
    }
    
    .breadcrumb {
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--text-light);
        font-size: 1rem;
    }
    
    .breadcrumb a {
        color: var(--primary-green);
        text-decoration: none;
        font-weight: 500;
        transition: color 0.3s ease;
    }
    
    .breadcrumb a:hover {
        color: var(--primary-orange);
        text-decoration: underline;
    }
    
    .breadcrumb span {
        font-weight: 600;
        color: var(--text-dark);
    }
    
    /* Responsive Design */
    @media (max-width: 1200px) {
        .charts-section {
            grid-template-columns: 1fr;
        }
        
        .chart-card {
            min-height: 300px;
        }
    }
    
    @media (max-width: 992px) {
        .form-row {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .stats-overview {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    
    @media (max-width: 768px) {
        .content-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 20px;
        }
        
        .action-buttons {
            width: 100%;
            justify-content: flex-start;
        }
        
        .form-row {
            grid-template-columns: 1fr;
        }
        
        .stats-overview {
            grid-template-columns: 1fr;
        }
        
        .table-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 20px;
        }
        
        .table-actions {
            width: 100%;
            justify-content: flex-start;
        }
        
        .table-footer {
            flex-direction: column;
            gap: 20px;
            align-items: flex-start;
        }
        
        .pagination-controls {
            width: 100%;
            justify-content: space-between;
        }
        
        .btn {
            width: 100%;
            justify-content: center;
        }
        
        .btn-secondary {
            padding: 10px 20px;
        }
    }
    
    @media (max-width: 576px) {
        .filter-controls,
        .feedback-table-container,
        .chart-card {
            padding: 20px;
        }
        
        .table-header,
        .table-footer {
            padding: 20px;
        }
        
        .feedback-table th,
        .feedback-table td {
            padding: 15px;
        }
        
        .action-buttons {
            flex-wrap: wrap;
        }
    }
</style>

<script>
    // Feedback Module JavaScript
    let feedbackData = [];
    let currentPage = 1;
    const itemsPerPage = 10;
    let totalPages = 1;
    let selectedFeedback = new Set();
    let ratingChart = null;
    let propertyChart = null;

    // helper to read CSS variables as JS color strings
    function cssVar(name) {
        try {
            return getComputedStyle(document.documentElement).getPropertyValue(name).trim() || name;
        } catch (e) {
            return name;
        }
    }

    // Initialize feedback module
    function initFeedbackModule() {
        loadFeedback();
        setupEventListeners();
    }

    function setupEventListeners() {
        // Search functionality (if added later)
        document.getElementById('searchInput')?.addEventListener('input', debounce(loadFeedback, 300));
    }

    async function loadFeedback() {
        try {
            const db = window.firebase.db;
            const { collection, query, where, orderBy, getDocs } = window.firebase.firestore;
            
            // Get filters
            const propertyFilter = document.getElementById('propertyFilter').value;
            const ratingFilter = document.getElementById('ratingFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            
            // Build query constraints
            let constraints = [];
            
            if (propertyFilter !== 'all') {
                constraints.push(where('property', '==', propertyFilter));
            }
            
            if (ratingFilter !== 'all') {
                constraints.push(where('rating', '>=', parseInt(ratingFilter)));
            }
            
            if (statusFilter !== 'all') {
                constraints.push(where('status', '==', statusFilter));
            }
            
            // Date filtering would require date range calculation
            // For now, just order by date
            constraints.push(orderBy('createdAt', 'desc'));
            
            // Build query
            let feedbackQuery;
            if (constraints.length > 0) {
                feedbackQuery = query(collection(db, 'feedback'), ...constraints);
            } else {
                feedbackQuery = query(collection(db, 'feedback'), orderBy('createdAt', 'desc'));
            }
            
            const snapshot = await getDocs(feedbackQuery);
            feedbackData = [];
            snapshot.forEach(doc => {
                feedbackData.push({
                    id: doc.id,
                    ...doc.data()
                });
            });
            
            // Update statistics
            updateStatistics();
            
            // Render table
            renderFeedbackTable();
            
            // Load charts
            loadCharts();
            
        } catch (error) {
            console.error('Error loading feedback:', error);
            showError('Failed to load feedback data');
        }
    }

    function updateStatistics() {
        if (feedbackData.length === 0) {
            document.getElementById('totalFeedback').textContent = '0';
            document.getElementById('averageRating').textContent = '0.0';
            document.getElementById('pendingReviews').textContent = '0';
            document.getElementById('recommendRate').textContent = '0%';
            return;
        }
        
        const total = feedbackData.length;
        const pending = feedbackData.filter(f => f.status === 'pending').length;
        const avgRating = (feedbackData.reduce((sum, f) => sum + parseInt(f.rating), 0) / total).toFixed(1);
        
        // For demo, calculate recommendation rate (assuming ratings 4+ recommend)
        const recommendCount = feedbackData.filter(f => parseInt(f.rating) >= 4).length;
        const recommendRate = Math.round((recommendCount / total) * 100);
        
        document.getElementById('totalFeedback').textContent = total.toLocaleString();
        document.getElementById('averageRating').textContent = avgRating;
        document.getElementById('pendingReviews').textContent = pending;
        document.getElementById('recommendRate').textContent = `${recommendRate}%`;
        
        // Update dashboard badge
        const newReviewsBadge = document.getElementById('newReviewsCount');
        if (newReviewsBadge) {
            newReviewsBadge.textContent = pending;
        }
    }

    function renderFeedbackTable() {
        const tbody = document.getElementById('feedbackTableBody');
        
        if (feedbackData.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="loading-state">
                        <i class="fas fa-inbox"></i> No feedback found
                    </td>
                </tr>
            `;
            return;
        }
        
        // Calculate pagination
        totalPages = Math.ceil(feedbackData.length / itemsPerPage);
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = Math.min(startIndex + itemsPerPage, feedbackData.length);
        const pageData = feedbackData.slice(startIndex, endIndex);
        
        let tableHTML = '';
        
        pageData.forEach(feedback => {
            const isSelected = selectedFeedback.has(feedback.id);
            const statusClass = getStatusClass(feedback.status);
            const propertyName = getPropertyName(feedback.property);
            const initials = getInitials(feedback.fullName);
            const date = feedback.createdAt?.toDate ? formatDate(feedback.createdAt.toDate()) : 'N/A';
            
            tableHTML += `
                <tr>
                    <td>
                        <input type="checkbox" value="${feedback.id}" ${isSelected ? 'checked' : ''} onchange="toggleFeedbackSelection('${feedback.id}')">
                    </td>
                    <td>
                        <div class="guest-info">
                            <div class="guest-avatar">${initials}</div>
                            <div class="guest-details">
                                <div class="guest-name">${feedback.fullName}</div>
                                <div class="guest-email">${feedback.email}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="property-badge">${propertyName}</span>
                    </td>
                    <td>
                        <div class="rating-stars">
                            ${'â˜…'.repeat(parseInt(feedback.rating))}${'â˜†'.repeat(5 - parseInt(feedback.rating))}
                        </div>
                        <div class="rating-value">${feedback.rating}/5</div>
                    </td>
                    <td>
                        <div class="feedback-title">${feedback.title}</div>
                        <div class="feedback-preview">${feedback.details}</div>
                    </td>
                    <td>
                        <span class="status-badge ${statusClass}">${feedback.status.charAt(0).toUpperCase() + feedback.status.slice(1)}</span>
                    </td>
                    <td>
                        <div class="feedback-date">${date}</div>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn view" onclick="viewFeedback('${feedback.id}')" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn edit" onclick="editFeedbackStatus('${feedback.id}')" title="Change Status">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn reply" onclick="replyToFeedback('${feedback.id}')" title="Reply">
                                <i class="fas fa-reply"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        tbody.innerHTML = tableHTML;
        
        // Update pagination info
        document.getElementById('currentCount').textContent = `${startIndex + 1}-${endIndex}`;
        document.getElementById('totalCount').textContent = feedbackData.length;
        
        // Update pagination buttons
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = currentPage === totalPages;
    }

    function loadCharts() {
        // Rating Distribution Chart
        const ratingCounts = {5: 0, 4: 0, 3: 0, 2: 0, 1: 0};
        feedbackData.forEach(f => {
            ratingCounts[f.rating] = (ratingCounts[f.rating] || 0) + 1;
        });
        
        const ratingCtx = document.getElementById('ratingDistributionChart').getContext('2d');
        if (ratingChart) ratingChart.destroy();
        
        ratingChart = new Chart(ratingCtx, {
            type: 'bar',
            data: {
                labels: ['5 Stars', '4 Stars', '3 Stars', '2 Stars', '1 Star'],
                datasets: [{
                    label: 'Number of Reviews',
                    data: [ratingCounts[5], ratingCounts[4], ratingCounts[3], ratingCounts[2], ratingCounts[1]],
                    backgroundColor: [
                        'rgba(34, 68, 15, 0.8)',
                        'rgba(26, 92, 26, 0.8)',
                        'rgba(243, 164, 53, 0.8)',
                        'rgba(255, 193, 7, 0.8)',
                        'rgba(220, 53, 69, 0.8)'
                    ],
                    borderColor: [
                        'rgba(34, 68, 15, 1)',
                        'rgba(26, 92, 26, 1)',
                        'rgba(243, 164, 53, 1)',
                        'rgba(255, 193, 7, 1)',
                        'rgba(220, 53, 69, 1)'
                    ]
                }],
            },
            options: {
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(255, 255, 255, 0.9)',
                        titleColor: cssVar('--primary-green'),
                        bodyColor: cssVar('--text-dark'),
                        borderColor: cssVar('--gray-border'),
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${context.raw}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1,
                            color: cssVar('--text-light')
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        ticks: {
                            color: cssVar('--text-light')
                        },
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
        
        // Property Feedback Chart
        const propertyCounts = {limuru: 0, kanamai: 0, kisumu: 0};
        feedbackData.forEach(f => {
            if (propertyCounts[f.property] !== undefined) {
                propertyCounts[f.property]++;
            }
        });
        
        const propertyCtx = document.getElementById('propertyFeedbackChart').getContext('2d');
        if (propertyChart) propertyChart.destroy();
        
        propertyChart = new Chart(propertyCtx, {
            type: 'doughnut',
            data: {
                labels: ['Limuru', 'Kanamai', 'Kisumu'],
                datasets: [{
                    data: [propertyCounts.limuru, propertyCounts.kanamai, propertyCounts.kisumu],
                    backgroundColor: [
                        'rgba(34, 68, 15, 0.8)',
                        'rgba(243, 164, 53, 0.8)',
                        'rgba(26, 92, 26, 0.8)'
                    ],
                    borderColor: [
                        'rgba(34, 68, 15, 1)',
                        'rgba(243, 164, 53, 1)',
                        'rgba(26, 92, 26, 1)'
                    ]
                }],
            },
            options: {
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            color: cssVar('--text-dark'),
                            font: {
                                size: 14,
                                family: "'Montserrat', sans-serif"
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(255, 255, 255, 0.9)',
                        titleColor: cssVar('--primary-green'),
                        bodyColor: cssVar('--text-dark'),
                        borderColor: cssVar('--gray-border'),
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((context.raw / total) * 100);
                                return `${context.label}: ${context.raw} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    // Utility functions
    function getStatusClass(status) {
        const classes = {
            'pending': 'status-pending',
            'published': 'status-published',
            'archived': 'status-archived',
            'replied': 'status-replied'
        };
        return classes[status] || 'status-pending';
    }

    function getPropertyName(propertyCode) {
        const properties = {
            'limuru': 'Limuru',
            'kanamai': 'Kanamai',
            'kisumu': 'Kisumu'
        };
        return properties[propertyCode] || propertyCode;
    }

    function getInitials(fullName) {
        return fullName.split(' ').map(name => name[0]).join('').toUpperCase().substring(0, 2);
    }

    function formatDate(date) {
        if (!date) return 'N/A';
        return date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    }

    function toggleSelectAll() {
        const selectAll = document.getElementById('selectAll').checked;
        const checkboxes = document.querySelectorAll('#feedbackTableBody input[type="checkbox"]');
        
        if (selectAll) {
            checkboxes.forEach(cb => {
                const id = cb.value;
                selectedFeedback.add(id);
                cb.checked = true;
            });
        } else {
            selectedFeedback.clear();
            checkboxes.forEach(cb => cb.checked = false);
        }
    }

    function toggleFeedbackSelection(id) {
        if (selectedFeedback.has(id)) {
            selectedFeedback.delete(id);
        } else {
            selectedFeedback.add(id);
        }
    }

    async function bulkAction(action) {
        if (selectedFeedback.size === 0) {
            showError('Please select feedback to perform this action');
            return;
        }
        
        try {
            const db = window.firebase.db;
            const batch = db.batch();
            
            selectedFeedback.forEach(id => {
                const feedbackRef = db.collection('feedback').doc(id);
                batch.update(feedbackRef, {
                    status: action === 'publish' ? 'published' : 'archived',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            });
            
            await batch.commit();
            
            showSuccess(`${selectedFeedback.size} feedback items ${action === 'publish' ? 'published' : 'archived'} successfully`);
            selectedFeedback.clear();
            document.getElementById('selectAll').checked = false;
            loadFeedback();
            
        } catch (error) {
            console.error('Error performing bulk action:', error);
            showError('Failed to perform bulk action');
        }
    }

    async function viewFeedback(id) {
        try {
            const db = window.firebase.db;
            const doc = await db.collection('feedback').doc(id).get();
            
            if (!doc.exists) {
                showError('Feedback not found');
                return;
            }
            
            const feedback = doc.data();
            const modalHTML = createFeedbackModal(feedback, id);
            
            // Show modal
            showModal('Feedback Details', modalHTML);
            
        } catch (error) {
            console.error('Error viewing feedback:', error);
            showError('Failed to load feedback details');
        }
    }

    function createFeedbackModal(feedback, id) {
        const propertyName = getPropertyName(feedback.property);
        const date = feedback.createdAt?.toDate ? formatDate(feedback.createdAt.toDate()) : 'N/A';
        
        return `
            <div class="feedback-modal-content">
                <div class="modal-header">
                    <div>
                        <h4>${feedback.fullName}</h4>
                        <div class="modal-subtitle">${feedback.email}</div>
                        ${feedback.phone ? `<div class="modal-subtitle">${feedback.phone}</div>` : ''}
                    </div>
                    <div class="modal-header-right">
                        <div class="modal-rating">
                            ${'â˜…'.repeat(parseInt(feedback.rating))}${'â˜†'.repeat(5 - parseInt(feedback.rating))}
                        </div>
                        <div class="modal-date">${date}</div>
                    </div>
                </div>
                
                <div class="modal-badges">
                    <span class="property-badge">${propertyName}</span>
                    <span class="status-badge ${getStatusClass(feedback.status)}">
                        ${feedback.status.charAt(0).toUpperCase() + feedback.status.slice(1)}
                    </span>
                </div>
                
                ${feedback.bookingReference ? `
                    <div class="modal-field">
                        <strong>Booking Reference:</strong> ${feedback.bookingReference}
                    </div>
                ` : ''}
                
                ${feedback.visitPurpose ? `
                    <div class="modal-field">
                        <strong>Purpose of Visit:</strong> ${feedback.visitPurpose}
                    </div>
                ` : ''}
                
                <div class="modal-feedback-content">
                    <h5>${feedback.title}</h5>
                    <p>${feedback.details}</p>
                </div>
                
                ${feedback.categoryRatings ? `
                    <div class="modal-categories">
                        <h5>Category Ratings</h5>
                        <div class="categories-grid">
                            ${Object.entries(feedback.categoryRatings).map(([category, rating]) => `
                                <div class="category-item">
                                    <div class="category-name">${category.charAt(0).toUpperCase() + category.slice(1)}</div>
                                    <div class="category-rating">
                                        ${'â˜…'.repeat(rating)}${'â˜†'.repeat(5 - rating)}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="changeStatus('${id}', '${feedback.status}')">
                        Change Status
                    </button>
                    <button class="btn btn-primary" onclick="replyToFeedback('${id}')">
                        <i class="fas fa-reply"></i> Reply
                    </button>
                </div>
            </div>
        `;
    }

    async function changeStatus(id, currentStatus) {
        const newStatus = prompt('Enter new status (pending/published/archived/replied):', currentStatus);
        
        if (!newStatus || !['pending', 'published', 'archived', 'replied'].includes(newStatus)) {
            showError('Invalid status');
            return;
        }
        
        try {
            const db = window.firebase.db;
            await db.collection('feedback').doc(id).update({
                status: newStatus,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            showSuccess('Status updated successfully');
            loadFeedback();
            
        } catch (error) {
            console.error('Error updating status:', error);
            showError('Failed to update status');
        }
    }

    async function replyToFeedback(id) {
        try {
            const db = window.firebase.db;
            const doc = await db.collection('feedback').doc(id).get();
            
            if (!doc.exists) {
                showError('Feedback not found');
                return;
            }
            
            const feedback = doc.data();
            const reply = prompt('Enter your reply to the guest:');
            
            if (!reply) return;
            
            // Send reply (this would integrate with email service)
            // For now, just update status and log the reply
            await db.collection('feedback').doc(id).update({
                status: 'replied',
                adminReply: reply,
                repliedAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Log activity
            await logActivity('replied to feedback', `Replied to feedback from ${feedback.fullName}`);
            
            showSuccess('Reply sent successfully');
            loadFeedback();
            
        } catch (error) {
            console.error('Error replying to feedback:', error);
            showError('Failed to send reply');
        }
    }

    async function exportFeedback() {
        try {
            // Create CSV content
            let csv = 'Guest Name,Email,Phone,Property,Rating,Title,Feedback,Status,Date\n';
            
            feedbackData.forEach(feedback => {
                const date = feedback.createdAt?.toDate ? formatDate(feedback.createdAt.toDate()) : 'N/A';
                const row = [
                    `"${feedback.fullName}"`,
                    `"${feedback.email}"`,
                    `"${feedback.phone || ''}"`,
                    `"${getPropertyName(feedback.property)}"`,
                    feedback.rating,
                    `"${feedback.title}"`,
                    `"${feedback.details.replace(/"/g, '""')}"`,
                    feedback.status,
                    `"${date}"`
                ];
                csv += row.join(',') + '\n';
            });
            
            // Create download link
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `jumuia-feedback-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showSuccess('Feedback exported successfully');
            
        } catch (error) {
            console.error('Error exporting feedback:', error);
            showError('Failed to export feedback');
        }
    }

    function refreshFeedback() {
        loadFeedback();
        showSuccess('Feedback data refreshed');
    }

    function prevPage() {
        if (currentPage > 1) {
            currentPage--;
            renderFeedbackTable();
        }
    }

    function nextPage() {
        if (currentPage < totalPages) {
            currentPage++;
            renderFeedbackTable();
        }
    }

    // Utility functions
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    function showError(message) {
        // Create styled alert
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-error';
        alertDiv.innerHTML = `
            <div class="alert-content">
                <i class="fas fa-exclamation-circle"></i>
                <span>${message}</span>
            </div>
            <button class="alert-close" onclick="this.parentElement.remove()">&times;</button>
        `;
        
        // Add alert styles if not already present
        if (!document.querySelector('#alert-styles')) {
            const style = document.createElement('style');
            style.id = 'alert-styles';
            style.textContent = `
                .alert {
                    position: fixed;
                    top: 100px;
                    right: 20px;
                    padding: 15px 20px;
                    border-radius: var(--radius);
                    box-shadow: var(--shadow);
                    z-index: 10000;
                    animation: slideIn 0.3s ease;
                    max-width: 400px;
                }
                .alert-error {
                    background-color: #f8d7da;
                    color: #721c24;
                    border-left: 4px solid #f5c6cb;
                }
                .alert-success {
                    background-color: #d4edda;
                    color: #155724;
                    border-left: 4px solid #c3e6cb;
                }
                .alert-content {
                    display: flex;
                    align-items: center;
                    gap: 10px;
                }
                .alert-close {
                    background: none;
                    border: none;
                    color: inherit;
                    font-size: 1.5rem;
                    cursor: pointer;
                    padding: 0;
                    margin-left: 15px;
                }
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
        }
        
        document.body.appendChild(alertDiv);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }

    function showSuccess(message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-success';
        alertDiv.innerHTML = `
            <div class="alert-content">
                <i class="fas fa-check-circle"></i>
                <span>${message}</span>
            </div>
            <button class="alert-close" onclick="this.parentElement.remove()">&times;</button>
        `;
        
        document.body.appendChild(alertDiv);
        
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }

    function showModal(title, content) {
        // Create modal HTML
        const modalHTML = `
            <div class="modal-overlay">
                <div class="modal-container">
                    <div class="modal-header">
                        <h3>${title}</h3>
                        <button class="modal-close" onclick="closeModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        ${content}
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal if any
        const existingModal = document.querySelector('.modal-overlay');
        if (existingModal) existingModal.remove();
        
        // Add modal styles if not already present
        if (!document.querySelector('#modal-styles')) {
            const style = document.createElement('style');
            style.id = 'modal-styles';
            style.textContent = `
                .modal-overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 2000;
                    animation: fadeIn 0.3s ease;
                }
                .modal-container {
                    background-color: var(--primary-white);
                    border-radius: var(--radius);
                    padding: 30px;
                    max-width: 800px;
                    width: 90%;
                    max-height: 90vh;
                    overflow-y: auto;
                    box-shadow: var(--shadow);
                    animation: slideUp 0.3s ease;
                }
                .modal-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 25px;
                    padding-bottom: 15px;
                    border-bottom: 1px solid var(--gray-border);
                }
                .modal-header h3 {
                    color: var(--primary-green);
                    font-family: 'Playfair Display', serif;
                    font-size: 1.5rem;
                    margin: 0;
                }
                .modal-close {
                    background: none;
                    border: none;
                    font-size: 1.8rem;
                    cursor: pointer;
                    color: var(--text-light);
                    line-height: 1;
                    padding: 5px;
                }
                .modal-close:hover {
                    color: var(--primary-orange);
                }
                .modal-body {
                    padding: 10px 0;
                }
                .feedback-modal-content {
                    display: flex;
                    flex-direction: column;
                    gap: 20px;
                }
                .modal-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: flex-start;
                    gap: 20px;
                }
                .modal-header h4 {
                    color: var(--primary-green);
                    font-family: 'Playfair Display', serif;
                    font-size: 1.3rem;
                    margin: 0 0 5px 0;
                }
                .modal-subtitle {
                    color: var(--text-light);
                    font-size: 0.9rem;
                }
                .modal-header-right {
                    text-align: right;
                }
                .modal-rating {
                    color: var(--primary-orange);
                    font-size: 1.5rem;
                    margin-bottom: 5px;
                }
                .modal-date {
                    color: var(--text-light);
                    font-size: 0.9rem;
                }
                .modal-badges {
                    display: flex;
                    gap: 10px;
                    flex-wrap: wrap;
                }
                .modal-field {
                    padding: 10px 0;
                    border-bottom: 1px solid var(--gray-border);
                }
                .modal-field strong {
                    color: var(--text-dark);
                    margin-right: 10px;
                }
                .modal-feedback-content {
                    background-color: var(--gray-bg);
                    padding: 20px;
                    border-radius: var(--radius);
                }
                .modal-feedback-content h5 {
                    color: var(--primary-green);
                    font-family: 'Playfair Display', serif;
                    font-size: 1.2rem;
                    margin: 0 0 15px 0;
                }
                .modal-feedback-content p {
                    color: var(--text-dark);
                    line-height: 1.6;
                    margin: 0;
                }
                .modal-categories {
                    margin-top: 10px;
                }
                .modal-categories h5 {
                    color: var(--primary-green);
                    font-family: 'Playfair Display', serif;
                    font-size: 1.1rem;
                    margin: 0 0 15px 0;
                }
                .categories-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                    gap: 15px;
                }
                .category-item {
                    background-color: var(--light-green);
                    padding: 15px;
                    border-radius: var(--radius);
                }
                .category-name {
                    font-weight: 600;
                    color: var(--text-dark);
                    margin-bottom: 10px;
                    text-transform: capitalize;
                }
                .category-rating {
                    color: var(--primary-orange);
                    font-size: 1.1rem;
                }
                .modal-actions {
                    display: flex;
                    gap: 15px;
                    justify-content: flex-end;
                    margin-top: 20px;
                    padding-top: 20px;
                    border-top: 1px solid var(--gray-border);
                }
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                @keyframes slideUp {
                    from { transform: translateY(50px); opacity: 0; }
                    to { transform: translateY(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
        }
        
        // Create new modal
        const modalDiv = document.createElement('div');
        modalDiv.innerHTML = modalHTML;
        document.body.appendChild(modalDiv);
    }

    function closeModal() {
        const modal = document.querySelector('.modal-overlay');
        if (modal) modal.remove();
    }

    async function logActivity(action, details) {
        try {
            const db = window.firebase.db;
            const userData = JSON.parse(localStorage.getItem('jumuiaAdminUser'));
            
            await db.collection('activities').add({
                type: 'feedback',
                description: details,
                user: userData?.name || 'Admin',
                metadata: {
                    action: action,
                    timestamp: new Date().toISOString()
                },
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
        } catch (error) {
            console.error('Error logging activity:', error);
        }
    }

    // Initialize when module loads
    window.addEventListener('load', function() {
        if (document.getElementById('feedbackModule').classList.contains('active')) {
            initFeedbackModule();
        }
    });
</script>
